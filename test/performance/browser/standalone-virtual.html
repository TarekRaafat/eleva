<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eleva.js Benchmark (Virtual Scrolling)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .jumbotron {
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .row {
      margin: 0 -7.5px;
    }

    .col-sm-6.smallpad {
      padding: 0 7.5px;
      margin-bottom: 5px;
    }

    .btn-block {
      width: 100%;
    }

    .danger {
      background-color: #f9d6d5 !important;
    }

    .glyphicon-remove {
      color: #888;
      cursor: pointer;
    }

    .glyphicon-remove:hover {
      color: #333;
    }

    .preloadicon {
      display: none;
    }

    #timing {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .optimization-note {
      background: #d4edda;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .virtual-viewport {
      height: 400px;
      overflow-y: auto;
      position: relative;
      border: 1px solid #ddd;
    }

    .virtual-viewport table {
      margin-bottom: 0;
    }

    .stats {
      background: #e7f3ff;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <div id="main"></div>
  <div class="container">
    <div class="optimization-note">
      <strong>Virtual Scrolling Version:</strong> Renders only visible rows (~17) instead of all rows.
      Compare with <a href="standalone.html">standalone.html</a> (standard version - renders all rows).
    </div>
    <div id="timing">
      <strong>Last operation:</strong> <span id="timing-result">-</span>
    </div>
    <div class="stats">
      <strong>Stats:</strong>
      Total rows: <span id="stat-total">0</span> |
      Rendered rows: <span id="stat-rendered">0</span> |
      Scroll position: <span id="stat-scroll">0</span>
    </div>
  </div>

  <script type="module">
    import Eleva from "../../../dist/eleva.esm.js";

    // Data Generation
    const adjectives = ["pretty", "large", "big", "small", "tall", "short", "long", "handsome", "plain", "quaint", "clean", "elegant", "easy", "angry", "crazy", "helpful", "mushy", "odd", "unsightly", "adorable", "important", "inexpensive", "cheap", "expensive", "fancy"];
    const colours = ["red", "yellow", "blue", "green", "pink", "brown", "purple", "brown", "white", "black", "orange"];
    const nouns = ["table", "chair", "house", "bbq", "desk", "car", "pony", "cookie", "sandwich", "burger", "pizza", "mouse", "keyboard"];

    let nextId = 1;
    const random = (max) => Math.round(Math.random() * 1000) % max;
    const buildData = (count) => {
      const data = [];
      for (let i = 0; i < count; i++) {
        data.push({
          id: nextId++,
          label: `${adjectives[random(adjectives.length)]} ${colours[random(colours.length)]} ${nouns[random(nouns.length)]}`
        });
      }
      return data;
    };

    // Timing helper
    const timed = (name, fn) => function (...args) {
      const start = performance.now();
      fn.apply(this, args);
      requestAnimationFrame(() => {
        document.getElementById("timing-result").textContent = `${name}: ${(performance.now() - start).toFixed(2)}ms`;
      });
    };

    // Config
    const ROW_HEIGHT = 37;
    const VIEWPORT_HEIGHT = 400;
    const VISIBLE_COUNT = Math.ceil(VIEWPORT_HEIGHT / ROW_HEIGHT) + 6;

    const app = new Eleva("BenchmarkApp");

    app.component("benchmark-app", {
      setup: ({ signal }) => {
        const rows = signal([]);
        const selected = signal(null);
        const scrollTop = signal(0);

        const handleScroll = (e) => {
          scrollTop.value = e.target.scrollTop;
        };

        const run = timed("Create 1,000 rows", () => {
          rows.value = buildData(1000);
          selected.value = null;
          scrollTop.value = 0;
        });

        const runLots = timed("Create 10,000 rows", () => {
          rows.value = buildData(10000);
          selected.value = null;
          scrollTop.value = 0;
        });

        const add = timed("Append 1,000 rows", () => {
          rows.value = [...rows.value, ...buildData(1000)];
        });

        const update = timed("Update every 10th row", () => {
          const newRows = [...rows.value];
          for (let i = 0; i < newRows.length; i += 10) {
            newRows[i] = { ...newRows[i], label: newRows[i].label + " !!!" };
          }
          rows.value = newRows;
        });

        const clear = timed("Clear", () => {
          rows.value = [];
          selected.value = null;
          scrollTop.value = 0;
        });

        const swapRows = timed("Swap rows", () => {
          if (rows.value.length > 998) {
            const newRows = [...rows.value];
            const temp = newRows[1];
            newRows[1] = newRows[998];
            newRows[998] = temp;
            rows.value = newRows;
          }
        });

        const selectRow = (id) => {
          selected.value = id;
        };

        const removeRow = (id) => {
          const start = performance.now();
          rows.value = rows.value.filter(row => row.id !== id);
          requestAnimationFrame(() => {
            document.getElementById("timing-result").textContent = `Remove row: ${(performance.now() - start).toFixed(2)}ms`;
          });
        };

        return {
          rows, selected, scrollTop, handleScroll,
          run, runLots, add, update, clear, swapRows, selectRow, removeRow
        };
      },

      template: (ctx) => {
        const allRows = ctx.rows.value;
        const scroll = ctx.scrollTop.value;
        const startIndex = Math.max(0, Math.floor(scroll / ROW_HEIGHT) - 3);
        const endIndex = Math.min(allRows.length, startIndex + VISIBLE_COUNT);
        const items = allRows.slice(startIndex, endIndex);
        const offset = startIndex * ROW_HEIGHT;
        const totalHeight = allRows.length * ROW_HEIGHT;

        // Update stats asynchronously
        requestAnimationFrame(() => {
          document.getElementById("stat-total").textContent = allRows.length;
          document.getElementById("stat-rendered").textContent = items.length;
          document.getElementById("stat-scroll").textContent = Math.round(scroll);
        });

        const renderRow = (row) => {
          const isSelected = ctx.selected.value === row.id;
          return `
            <tr key="${row.id}" class="${isSelected ? 'danger' : ''}" style="height: ${ROW_HEIGHT}px;">
              <td class="col-md-1">${row.id}</td>
              <td class="col-md-4">
                <a class="lbl" @click="() => selectRow(${row.id})">${row.label}</a>
              </td>
              <td class="col-md-1">
                <a class="remove" @click="() => removeRow(${row.id})">
                  <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                </a>
              </td>
              <td class="col-md-6"></td>
            </tr>
          `;
        };

        return `
          <div class="container">
            <div class="jumbotron">
              <div class="row">
                <div class="col-md-6">
                  <h1>Eleva.js (virtual)</h1>
                </div>
                <div class="col-md-6">
                  <div class="row">
                    <div class="col-sm-6 smallpad">
                      <button type="button" class="btn btn-primary btn-block" id="run" @click="run">Create 1,000 rows</button>
                    </div>
                    <div class="col-sm-6 smallpad">
                      <button type="button" class="btn btn-primary btn-block" id="runlots" @click="runLots">Create 10,000 rows</button>
                    </div>
                    <div class="col-sm-6 smallpad">
                      <button type="button" class="btn btn-primary btn-block" id="add" @click="add">Append 1,000 rows</button>
                    </div>
                    <div class="col-sm-6 smallpad">
                      <button type="button" class="btn btn-primary btn-block" id="update" @click="update">Update every 10th row</button>
                    </div>
                    <div class="col-sm-6 smallpad">
                      <button type="button" class="btn btn-primary btn-block" id="clear" @click="clear">Clear</button>
                    </div>
                    <div class="col-sm-6 smallpad">
                      <button type="button" class="btn btn-primary btn-block" id="swaprows" @click="swapRows">Swap Rows</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="virtual-viewport" @scroll="handleScroll">
              <div style="height: ${totalHeight}px; position: relative;">
                <table class="table table-hover table-striped test-data" style="position: absolute; top: ${offset}px; width: 100%;">
                  <tbody id="tbody">
                    ${items.map(renderRow).join("")}
                  </tbody>
                </table>
              </div>
            </div>
            <span class="preloadicon glyphicon glyphicon-remove" aria-hidden="true"></span>
          </div>
        `;
      }
    });

    app.mount(document.getElementById("main"), "benchmark-app");
    console.log("Eleva.js Virtual Scrolling Benchmark loaded.");
  </script>
</body>

</html>