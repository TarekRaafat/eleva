var e,t;e=this,t=function(e){"use strict";let t={handle(e,t,r={}){let i=Error(`[ElevaRouter] ${t}: ${e.message}`);throw i.originalError=e,i.context=t,i.details=r,i},warn(e,t={}){},log(e,t,r={}){}};class r{_validateOptions(){["hash","query","history"].includes(this.options.mode)||this.errorHandler.handle(Error(`Invalid routing mode: ${this.options.mode}. Must be "hash", "query", or "history".`),"Configuration validation failed")}_processRoutes(e){let t=[];for(let r of e)try{t.push({...r,segments:this._parsePathIntoSegments(r.path)})}catch(e){this.errorHandler.warn(`Invalid path in route definition "${r.path||"undefined"}": ${e.message}`,{route:r,error:e})}return t}_parsePathIntoSegments(e){e&&"string"==typeof e||this.errorHandler.handle(Error("Route path must be a non-empty string"),"Path parsing failed",{path:e});let t=e.replace(/\/+/g,"/").replace(/\/$/,"")||"/";return"/"===t?[]:t.split("/").filter(Boolean).map(t=>{if(t.startsWith(":")){let r=t.substring(1);return r||this.errorHandler.handle(Error(`Invalid parameter segment: ${t}`),"Path parsing failed",{segment:t,path:e}),{type:"param",name:r}}return{type:"static",value:t}})}_findViewElement(e){let t=this.options.viewSelector;return e.querySelector(`#${t}`)||e.querySelector(`.${t}`)||e.querySelector(`[data-${t}]`)||e.querySelector(t)||e}async start(){if(this.isStarted)return this.errorHandler.warn("Router is already started"),this;if("u"<typeof window)return this.errorHandler.warn("Router start skipped: `window` object not available (SSR environment)"),this;if("u">typeof document&&!document.querySelector(this.options.mount))return this.errorHandler.warn(`Mount element "${this.options.mount}" was not found in the DOM. The router will not start.`,{mountSelector:this.options.mount}),this;let e=()=>this._handleRouteChange();return"hash"===this.options.mode?(window.addEventListener("hashchange",e),this.eventListeners.push(()=>window.removeEventListener("hashchange",e))):(window.addEventListener("popstate",e),this.eventListeners.push(()=>window.removeEventListener("popstate",e))),this.isStarted=!0,await this._handleRouteChange(!1),this.isReady.value=!0,await this.emitter.emit("router:ready",this),this}async destroy(){if(this.isStarted){for(let e of this.plugins.values())if("function"==typeof e.destroy)try{await e.destroy(this)}catch(t){this.errorHandler.log(`Plugin ${e.name} destroy failed`,t)}this.eventListeners.forEach(e=>e()),this.eventListeners=[],this.currentLayout.value&&await this.currentLayout.value.unmount(),this.isStarted=!1,this.isReady.value=!1}}async stop(){return this.destroy()}async navigate(e,t={}){try{let r="string"==typeof e?{path:e,params:t}:e,i=this._buildPath(r.path,r.params||{}),o=r.query||{};if(Object.keys(o).length>0){let e=new URLSearchParams(o).toString();e&&(i+=`?${e}`)}if(this._isSameRoute(i,r.params,o))return!0;let n=await this._proceedWithNavigation(i);if(n){let e=++this._navigationId;this._isNavigating=!0;let t=r.state||{},o=r.replace||!1;if("hash"===this.options.mode)if(o){let e=`${window.location.pathname}${window.location.search}#${i}`;window.history.replaceState(t,"",e)}else window.location.hash=i;else{let e="query"===this.options.mode?this._buildQueryUrl(i):i;history[o?"replaceState":"pushState"](t,"",e)}queueMicrotask(()=>{this._navigationId===e&&(this._isNavigating=!1)})}return n}catch(e){return this.errorHandler.log("Navigation failed",e),await this.emitter.emit("router:error",e),!1}}_buildQueryUrl(e){let t=new URLSearchParams(window.location.search);return t.set(this.options.queryParam,e.split("?")[0]),`${window.location.pathname}?${t.toString()}`}_isSameRoute(e,t,r){let i=this.currentRoute.value;if(!i)return!1;let[o,n]=e.split("?"),a=r||this._parseQuery(n||"");return i.path===o&&JSON.stringify(i.params)===JSON.stringify(t||{})&&JSON.stringify(i.query)===JSON.stringify(a)}_buildPath(e,t){let r=e;for(let[e,i]of Object.entries(t)){let t=encodeURIComponent(String(i));r=r.replace(RegExp(`:${e}\\b`,"g"),t)}return r}async _handleRouteChange(e=!0){if(!this._isNavigating)try{let t=this.currentRoute.value,r=this._getCurrentLocation();!await this._proceedWithNavigation(r.fullUrl,e)&&t&&this.navigate({path:t.path,query:t.query,replace:!0})}catch(e){this.errorHandler.log("Route change handling failed",e,{currentUrl:"u">typeof window?window.location.href:""}),await this.emitter.emit("router:error",e)}}async _proceedWithNavigation(e,t=!1){let r=this.currentRoute.value,[i,o]=(e||"/").split("?"),n={path:i.startsWith("/")?i:`/${i}`,query:this._parseQuery(o),fullUrl:e},a=this._matchRoute(n.path);if(!a){let e=this.routes.find(e=>"*"===e.path);if(!e)return await this.emitter.emit("router:error",Error(`Route not found: ${n.path}`),n,r),!1;a={route:e,params:{pathMatch:decodeURIComponent(n.path.substring(1))}}}let s={...n,params:a.params,meta:a.route.meta||{},name:a.route.name,matched:a.route};try{if(!await this._runGuards(s,r,a.route))return!1;r&&"u">typeof window&&this._scrollPositions.set(r.path,{x:window.scrollX||window.pageXOffset||0,y:window.scrollY||window.pageYOffset||0});let e={to:s,from:r,route:a.route,layoutComponent:null,pageComponent:null,cancelled:!1,redirectTo:null};if(await this.emitter.emit("router:beforeResolve",e),e.cancelled)return!1;if(e.redirectTo)return this.navigate(e.redirectTo),!1;let{layoutComponent:i,pageComponent:o}=await this._resolveComponents(a.route);if(e.layoutComponent=i,e.pageComponent=o,await this.emitter.emit("router:afterResolve",e),r){let e=a.route.layout||this.options.globalLayout,t=r.matched.layout||this.options.globalLayout,i=async e=>{if(e)try{await e.unmount()}catch(t){this.errorHandler.warn("Error during component unmount",{error:t,instance:e})}};e!==t?(await i(this.currentLayout.value),this.currentLayout.value=null):(await i(this.currentView.value),this.currentView.value=null),r.matched.afterLeave&&await r.matched.afterLeave(s,r),await this.emitter.emit("router:afterLeave",s,r)}this.previousRoute.value=r,this.currentRoute.value=s,this.currentParams.value=s.params||{},this.currentQuery.value=s.query||{};let n={to:s,from:r,layoutComponent:i,pageComponent:o};await this.emitter.emit("router:beforeRender",n),await this._render(i,o),await this.emitter.emit("router:afterRender",n);let u={to:s,from:r,savedPosition:t&&this._scrollPositions.get(s.path)||null};return await this.emitter.emit("router:scroll",u),a.route.afterEnter&&await a.route.afterEnter(s,r),await this.emitter.emit("router:afterEnter",s,r),await this.emitter.emit("router:afterEach",s,r),!0}catch(e){return this.errorHandler.log("Error during navigation",e,{to:s,from:r}),await this.emitter.emit("router:error",e,s,r),!1}}async _runGuards(e,t,r){let i={to:e,from:t,cancelled:!1,redirectTo:null};if(await this.emitter.emit("router:beforeEach",i),i.cancelled)return!1;if(i.redirectTo)return this.navigate(i.redirectTo),!1;for(let i of[...this._beforeEachGuards,...t&&t.matched.beforeLeave?[t.matched.beforeLeave]:[],...r.beforeEnter?[r.beforeEnter]:[]]){let r=await i(e,t);if(!1===r)return!1;if("string"==typeof r||"object"==typeof r)return this.navigate(r),!1}return!0}_resolveStringComponent(e){let t=this.eleva._components.get(e);return t||this.errorHandler.handle(Error(`Component "${e}" not registered.`),"Component resolution failed",{componentName:e,availableComponents:Array.from(this.eleva._components.keys())}),t}async _resolveFunctionComponent(e){try{let t=e.toString(),r=t.includes("import(")||t.startsWith("() =>"),i=await e();return r&&i.default||i}catch(t){this.errorHandler.handle(Error(`Failed to load async component: ${t.message}`),"Component resolution failed",{function:e.toString(),error:t})}}_validateComponentDefinition(e){return e&&"object"==typeof e||this.errorHandler.handle(Error(`Invalid component definition: ${typeof e}`),"Component validation failed",{definition:e}),"function"!=typeof e.template&&"string"!=typeof e.template&&this.errorHandler.handle(Error("Component missing template property"),"Component validation failed",{definition:e}),e}async _resolveComponent(e){return null==e?null:"string"==typeof e?this._resolveStringComponent(e):"function"==typeof e?await this._resolveFunctionComponent(e):e&&"object"==typeof e?this._validateComponentDefinition(e):void this.errorHandler.handle(Error(`Invalid component definition: ${typeof e}`),"Component resolution failed",{definition:e})}async _resolveComponents(e){let t=e.layout||this.options.globalLayout;try{let[r,i]=await Promise.all([this._resolveComponent(t),this._resolveComponent(e.component)]);return i||this.errorHandler.handle(Error(`Page component is null or undefined for route: ${e.path}`),"Component resolution failed",{route:e.path}),{layoutComponent:r,pageComponent:i}}catch(t){throw this.errorHandler.log(`Error resolving components for route ${e.path}`,t,{route:e.path}),t}}async _render(e,t){let r=document.querySelector(this.options.mount);if(r||this.errorHandler.handle(Error(`Mount element "${this.options.mount}" not found.`),{mountSelector:this.options.mount}),e){let i=await this.eleva.mount(r,this._wrapComponentWithChildren(e));this.currentLayout.value=i;let o=this._findViewElement(i.container),n=await this.eleva.mount(o,this._wrapComponentWithChildren(t));this.currentView.value=n}else{let e=await this.eleva.mount(r,this._wrapComponentWithChildren(t));this.currentView.value=e,this.currentLayout.value=null}}_createRouteGetter(e,t){return()=>this.currentRoute.value?.[e]??t}_wrapComponent(e){let t=e.setup,r=this;return{...e,setup:async e=>(e.router={navigate:r.navigate.bind(r),current:r.currentRoute,previous:r.previousRoute,get params(){return r._createRouteGetter("params",{})()},get query(){return r._createRouteGetter("query",{})()},get path(){return r._createRouteGetter("path","/")()},get fullUrl(){return r._createRouteGetter("fullUrl",window.location.href)()},get meta(){return r._createRouteGetter("meta",{})()}},t?await t(e):{})}}_wrapComponentWithChildren(e){if("string"==typeof e||!e||"object"!=typeof e)return e;let t=this._wrapComponent(e);if(t.children&&"object"==typeof t.children){let e={};for(let[r,i]of Object.entries(t.children))e[r]=this._wrapComponentWithChildren(i);t.children=e}return t}_getCurrentLocation(){let e,t,r;if("u"<typeof window)return{path:"/",query:{},fullUrl:""};switch(this.options.mode){case"hash":r=window.location.hash.slice(1)||"/",[e,t]=r.split("?");break;case"query":e=new URLSearchParams(window.location.search).get(this.options.queryParam)||"/",t=window.location.search.slice(1),r=e;break;default:e=window.location.pathname||"/",t=window.location.search.slice(1),r=`${e}${t?"?"+t:""}`}return{path:e.startsWith("/")?e:`/${e}`,query:this._parseQuery(t),fullUrl:r}}_parseQuery(e){let t={};return e&&new URLSearchParams(e).forEach((e,r)=>{t[r]=e}),t}_matchRoute(e){let t=e.split("/").filter(Boolean);for(let e of this.routes){if("/"===e.path){if(0===t.length)return{route:e,params:{}};continue}if(e.segments.length!==t.length)continue;let r={},i=!0;for(let o=0;o<e.segments.length;o++){let n=e.segments[o],a=t[o];if("param"===n.type)r[n.name]=decodeURIComponent(a);else if(n.value!==a){i=!1;break}}if(i)return{route:e,params:r}}return null}addRoute(e,t=null){if(!e||!e.path)return this.errorHandler.warn("Invalid route definition: missing path",{route:e}),()=>{};if(this.hasRoute(e.path))return this.errorHandler.warn(`Route "${e.path}" already exists`,{route:e}),()=>{};let r={...e,segments:this._parsePathIntoSegments(e.path)},i=this.routes.findIndex(e=>"*"===e.path);return -1!==i?this.routes.splice(i,0,r):this.routes.push(r),this.emitter.emit("router:routeAdded",r),()=>this.removeRoute(e.path)}removeRoute(e){let t=this.routes.findIndex(t=>t.path===e);if(-1===t)return!1;let[r]=this.routes.splice(t,1);return this.emitter.emit("router:routeRemoved",r),!0}hasRoute(e){return this.routes.some(t=>t.path===e)}getRoutes(){return[...this.routes]}getRoute(e){return this.routes.find(t=>t.path===e)}onBeforeEach(e){return this._beforeEachGuards.push(e),()=>{let t=this._beforeEachGuards.indexOf(e);t>-1&&this._beforeEachGuards.splice(t,1)}}onAfterEnter(e){return this.emitter.on("router:afterEnter",e)}onAfterLeave(e){return this.emitter.on("router:afterLeave",e)}onAfterEach(e){return this.emitter.on("router:afterEach",e)}onError(e){return this.emitter.on("router:error",e)}use(e,t={}){("function"!=typeof e.install&&this.errorHandler.handle(Error("Plugin must have an install method"),"Plugin registration failed",{plugin:e}),this.plugins.has(e.name))?this.errorHandler.warn(`Plugin "${e.name}" is already registered`,{existingPlugin:this.plugins.get(e.name)}):(this.plugins.set(e.name,e),e.install(this,t))}getPlugins(){return Array.from(this.plugins.values())}getPlugin(e){return this.plugins.get(e)}removePlugin(e){let t=this.plugins.get(e);if(!t)return!1;if("function"==typeof t.destroy)try{t.destroy(this)}catch(t){this.errorHandler.log(`Plugin ${e} destroy failed`,t)}return this.plugins.delete(e)}setErrorHandler(e){e&&"function"==typeof e.handle&&"function"==typeof e.warn&&"function"==typeof e.log&&(this.errorHandler=e)}constructor(e,r={}){this.eleva=e,this.options={mode:"hash",queryParam:"view",viewSelector:"view",...r},this.routes=this._processRoutes(r.routes||[]),this.emitter=this.eleva.emitter,this.isStarted=!1,this._isNavigating=!1,this._navigationId=0,this.eventListeners=[],this.currentRoute=new this.eleva.signal(null),this.previousRoute=new this.eleva.signal(null),this.currentParams=new this.eleva.signal({}),this.currentQuery=new this.eleva.signal({}),this.currentLayout=new this.eleva.signal(null),this.currentView=new this.eleva.signal(null),this.isReady=new this.eleva.signal(!1),this.plugins=new Map,this._beforeEachGuards=[],r.onBeforeEach&&this._beforeEachGuards.push(r.onBeforeEach),this.errorHandler=t,this._scrollPositions=new Map,this._validateOptions()}}let i={name:"router",version:"1.1.0",description:"Client-side routing for Eleva applications",install(e,t={}){if(!t.mount)throw Error("[RouterPlugin] 'mount' option is required");if(!t.routes||!Array.isArray(t.routes))throw Error("[RouterPlugin] 'routes' option must be an array");let i=(t,r)=>{if(!t)return null;if("object"==typeof t&&null!==t&&!t.name){let i=`Eleva${r}Component_${Math.random().toString(36).slice(2,11)}`;try{return e.component(i,t),i}catch(e){throw Error(`[RouterPlugin] Failed to register ${r} component: ${e.message}`)}}return t};t.globalLayout&&(t.globalLayout=i(t.globalLayout,"GlobalLayout")),(t.routes||[]).forEach(e=>{e.component=i(e.component,"Route"),e.layout&&(e.layout=i(e.layout,"RouteLayout"))});let o=new r(e,t);return e.router=o,!1!==t.autoStart&&queueMicrotask(()=>o.start()),e.plugins||(e.plugins=new Map),e.plugins.set(this.name,{name:this.name,version:this.version,description:this.description,options:t}),e.navigate=o.navigate.bind(o),e.getCurrentRoute=()=>o.currentRoute.value,e.getRouteParams=()=>o.currentParams.value,e.getRouteQuery=()=>o.currentQuery.value,o},async uninstall(e){e.router&&(await e.router.destroy(),delete e.router),e.plugins&&e.plugins.delete(this.name),delete e.navigate,delete e.getCurrentRoute,delete e.getRouteParams,delete e.getRouteQuery}};e.Router=i,e.RouterPlugin=i},"object"==typeof exports&&"u">typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="u">typeof globalThis?globalThis:e||self).ElevaRouterPlugin={});
//# sourceMappingURL=router.umd.min.js.map
