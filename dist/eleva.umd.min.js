var e,t;e=this,t=function(){"use strict";class e{static parse(e,t){return"string"!=typeof e?e:e.replace(this.expressionPattern,(e,n)=>this.evaluate(n,t))}static evaluate(e,t){if("string"!=typeof e)return e;let n=this._functionCache.get(e);if(!n)try{n=Function("data",`with(data) { return ${e}; }`),this._functionCache.set(e,n)}catch{return}try{return n(t)}catch{return}}}e.expressionPattern=/\{\{\s*(.*?)\s*\}\}/g,e._functionCache=new Map;class t{get value(){return this._value}set value(e){this._value!==e&&(this._value=e,this._notify())}watch(e){return this._watchers.add(e),()=>this._watchers.delete(e)}_notify(){for(let e of this._watchers)e(this._value)}constructor(e){this._value=e,this._watchers=new Set}}class n{on(e,t){let n=this._events.get(e);return n||this._events.set(e,n=new Set),n.add(t),()=>this.off(e,t)}off(e,t){if(this._events.has(e))if(t){let n=this._events.get(e);n.delete(t),0===n.size&&this._events.delete(e)}else this._events.delete(e)}emit(e,...t){let n=this._events.get(e);if(n)for(let e of n)e(...t)}constructor(){this._events=new Map}}class i{patchDOM(e,t){this._tempContainer.innerHTML=t,this._diff(e,this._tempContainer)}_diff(e,t){if(!e.firstChild&&!t.firstChild)return;let n=Array.from(e.childNodes),i=Array.from(t.childNodes),s=0,o=0,r=n.length-1,a=i.length-1,l=null;for(;s<=r&&o<=a;){let t=n[s],a=i[o];if(!t){s++;continue}if(this._isSameNode(t,a))this._patchNode(t,a),s++,o++;else{l||(l=this._createKeyMap(n,s,r));let i=this._getNodeKey(a),u=i?l.get(i):null;u&&u.nodeName===a.nodeName?(this._patchNode(u,a),e.insertBefore(u,t),n[n.indexOf(u)]=null):e.insertBefore(a.cloneNode(!0),t),o++}}if(s>r){let t=i[a+1]?n[s]:null;for(let n=o;n<=a;n++)i[n]&&e.insertBefore(i[n].cloneNode(!0),t)}else if(o>a)for(let t=s;t<=r;t++)n[t]&&this._removeNode(e,n[t])}_patchNode(e,t){e._eleva_instance||(3===e.nodeType?e.nodeValue!==t.nodeValue&&(e.nodeValue=t.nodeValue):1===e.nodeType&&(this._updateAttributes(e,t),this._diff(e,t)))}_removeNode(e,t){"STYLE"===t.nodeName&&t.hasAttribute("data-e-style")||e.removeChild(t)}_updateAttributes(e,t){for(let n of t.attributes)"@"!==n.name[0]&&e.getAttribute(n.name)!==n.value&&e.setAttribute(n.name,n.value);for(let n=e.attributes.length-1;n>=0;n--)t.hasAttribute(e.attributes[n].name)||e.removeAttribute(e.attributes[n].name)}_isSameNode(e,t){if(!e||!t)return!1;let n=this._getNodeKey(e),i=this._getNodeKey(t);return n&&i?n===i&&e.nodeName===t.nodeName:!n&&!i&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName}_getNodeKey(e){return e?.nodeType===1?e.getAttribute("key"):null}_createKeyMap(e,t,n){let i=new Map;for(let s=t;s<=n;s++){let t=this._getNodeKey(e[s]);t&&i.set(t,e[s])}return i}constructor(){this._tempContainer=document.createElement("div")}}return class{use(e,t={}){if(!e?.install||"function"!=typeof e.install)throw Error("Eleva: plugin must have an install function");this._plugins.set(e.name,e);let n=e.install(this,t);return void 0!==n?n:this}component(e,t){if(!e||"string"!=typeof e)throw Error("Eleva: component name must be a non-empty string");if(!t?.template)throw Error(`Eleva: component "${e}" must have a template`);return this._components.set(e,t),this}async mount(e,n,i={}){if(!e?.nodeType)throw Error("Eleva: container must be a DOM element");if(e._eleva_instance)return e._eleva_instance;let s="string"==typeof n?this._components.get(n):n;if(!s)throw Error(`Component "${n}" not registered.`);let o=`c${++this._componentCounter}`,{setup:r,template:a,style:l,children:u}=s,h={props:i,emitter:this.emitter,signal:e=>new this.signal(e)},c=async n=>{let i={...h,...n},s=[],r=[],c=[],f=!1,d=!1,m=()=>{d||(d=!0,queueMicrotask(()=>{p().finally(()=>{d=!1})}))},p=async()=>{let t="function"==typeof a?await a(i):a,n=this.templateEngine.parse(t,i);f?await i.onBeforeUpdate?.({container:e,context:i}):await i.onBeforeMount?.({container:e,context:i}),this.renderer.patchDOM(e,n),this._processEvents(e,i,c),l&&this._injectStyles(e,o,l,i),u&&await this._mountComponents(e,u,r),f?await i.onUpdate?.({container:e,context:i}):(await i.onMount?.({container:e,context:i}),f=!0)};for(let e of Object.values(n))e instanceof t&&s.push(e.watch(m));await p();let _={container:e,data:i,async unmount(){for(let t of(await i.onUnmount?.({container:e,context:i,cleanup:{watchers:s,listeners:c,children:r}}),s))t();for(let e of c)e();for(let e of r)await e.unmount();e.innerHTML="",delete e._eleva_instance}};return e._eleva_instance=_,_},f="function"==typeof r?await r(h):{};return await c(f)}_processEvents(e,t,n){for(let i of e.querySelectorAll("*")){let e=i.attributes;for(let s=0;s<e.length;s++){let o=e[s];if(!o.name.startsWith("@"))continue;let r=o.name.slice(1),a=o.value,l=t[a]||this.templateEngine.evaluate(a,t);"function"==typeof l&&(i.addEventListener(r,l),i.removeAttribute(o.name),n.push(()=>i.removeEventListener(r,l)))}}}_injectStyles(e,t,n,i){let s="function"==typeof n?this.templateEngine.parse(n(i),i):n,o=e.querySelector(`style[data-e-style="${t}"]`);o&&o.textContent===s||(o||((o=document.createElement("style")).setAttribute("data-e-style",t),e.appendChild(o)),o.textContent=s)}_extractProps(e){if(!e.attributes)return{};let t={},n=e.attributes;for(let i=n.length-1;i>=0;i--){let s=n[i];s.name.startsWith(":")&&(t[s.name.slice(1)]=s.value,e.removeAttribute(s.name))}return t}async _mountComponents(e,t,n){for(let[i,s]of Object.entries(t))if(i)for(let t of e.querySelectorAll(i)){if(!(t instanceof HTMLElement))continue;let e=this._extractProps(t),i=await this.mount(t,s,e);i&&!n.includes(i)&&n.push(i)}}constructor(s,o={}){if(!s||"string"!=typeof s)throw Error("Eleva: name must be a non-empty string");this.name=s,this.config=o,this.emitter=new n,this.signal=t,this.templateEngine=e,this.renderer=new i,this._components=new Map,this._plugins=new Map,this._componentCounter=0}}},"object"==typeof exports&&"u">typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="u">typeof globalThis?globalThis:e||self).Eleva=t();
//# sourceMappingURL=eleva.umd.min.js.map
