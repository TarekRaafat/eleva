{"version":3,"file":"router.umd.js","sources":["../../src/plugins/Router.js"],"sourcesContent":["\"use strict\";\n\n/**\n * @typedef {import('eleva').Eleva} Eleva\n * @typedef {import('eleva').Signal} Signal\n * @typedef {import('eleva').ComponentDefinition} ComponentDefinition\n * @typedef {import('eleva').Emitter} Emitter\n * @typedef {import('eleva').MountResult} MountResult\n */\n\n// ============================================\n// Core Type Definitions\n// ============================================\n\n/**\n * @typedef {'hash' | 'history' | 'query'} RouterMode\n * The routing mode determines how the router manages URL state.\n * - `hash`: Uses URL hash (e.g., `/#/path`) - works without server config\n * - `history`: Uses HTML5 History API (e.g., `/path`) - requires server config\n * - `query`: Uses query parameters (e.g., `?view=/path`) - useful for embedded apps\n */\n\n/**\n * @typedef {Object} RouterOptions\n * @property {RouterMode} [mode='hash'] - The routing mode to use.\n * @property {string} [queryParam='view'] - Query parameter name for 'query' mode.\n * @property {string} [viewSelector='root'] - Selector for the view container element.\n * @property {string} mount - CSS selector for the mount point element.\n * @property {RouteDefinition[]} routes - Array of route definitions.\n * @property {string | ComponentDefinition} [globalLayout] - Default layout for all routes.\n * @property {NavigationGuard} [onBeforeEach] - Global navigation guard.\n * @description Configuration options for the Router plugin.\n */\n\n/**\n * @typedef {Object} NavigationTarget\n * @property {string} path - The target path (can include params like '/users/:id').\n * @property {Record<string, string>} [params] - Route parameters to inject into the path.\n * @property {Record<string, string>} [query] - Query parameters to append.\n * @property {boolean} [replace=false] - Whether to replace current history entry.\n * @property {Record<string, any>} [state] - State object to pass to history.\n * @description Object describing a navigation target for `router.navigate()`.\n */\n\n/**\n * @typedef {Object} ScrollPosition\n * @property {number} x - Horizontal scroll position.\n * @property {number} y - Vertical scroll position.\n * @description Represents a saved scroll position.\n */\n\n/**\n * @typedef {Object} RouteSegment\n * @property {'static' | 'param'} type - The segment type.\n * @property {string} value - The segment value (for static) or empty string (for param).\n * @property {string} [name] - The parameter name (for param segments).\n * @description Internal representation of a parsed route path segment.\n * @private\n */\n\n/**\n * @typedef {Object} RouteMatch\n * @property {RouteDefinition} route - The matched route definition.\n * @property {Record<string, string>} params - The extracted route parameters.\n * @description Result of matching a path against route definitions.\n * @private\n */\n\n/**\n * @typedef {Record<string, any>} RouteMeta\n * @description Arbitrary metadata attached to routes for use in guards and components.\n * Common properties include:\n * - `requiresAuth: boolean` - Whether the route requires authentication\n * - `title: string` - Page title for the route\n * - `roles: string[]` - Required user roles\n * @example\n * {\n *   path: '/admin',\n *   component: AdminPage,\n *   meta: { requiresAuth: true, roles: ['admin'], title: 'Admin Dashboard' }\n * }\n */\n\n/**\n * @typedef {Object} RouterErrorHandler\n * @property {(error: Error, context: string, details?: Record<string, any>) => void} handle - Throws a formatted error.\n * @property {(message: string, details?: Record<string, any>) => void} warn - Logs a warning.\n * @property {(message: string, error: Error, details?: Record<string, any>) => void} log - Logs an error without throwing.\n * @description Interface for the router's error handling system.\n */\n\n// ============================================\n// Event Callback Type Definitions\n// ============================================\n\n/**\n * @callback NavigationContextCallback\n * @param {NavigationContext} context - The navigation context (can be modified to block/redirect).\n * @returns {void | Promise<void>}\n * @description Callback for `router:beforeEach` event. Modify context to control navigation.\n */\n\n/**\n * @callback ResolveContextCallback\n * @param {ResolveContext} context - The resolve context (can be modified to block/redirect).\n * @returns {void | Promise<void>}\n * @description Callback for `router:beforeResolve` and `router:afterResolve` events.\n */\n\n/**\n * @callback RenderContextCallback\n * @param {RenderContext} context - The render context.\n * @returns {void | Promise<void>}\n * @description Callback for `router:beforeRender` and `router:afterRender` events.\n */\n\n/**\n * @callback ScrollContextCallback\n * @param {ScrollContext} context - The scroll context with saved position info.\n * @returns {void | Promise<void>}\n * @description Callback for `router:scroll` event. Use to implement scroll behavior.\n */\n\n/**\n * @callback RouteChangeCallback\n * @param {RouteLocation} to - The target route location.\n * @param {RouteLocation | null} from - The source route location.\n * @returns {void | Promise<void>}\n * @description Callback for `router:afterEnter`, `router:afterLeave`, `router:afterEach` events.\n */\n\n/**\n * @callback RouterErrorCallback\n * @param {Error} error - The error that occurred.\n * @param {RouteLocation} [to] - The target route (if available).\n * @param {RouteLocation | null} [from] - The source route (if available).\n * @returns {void | Promise<void>}\n * @description Callback for `router:onError` event.\n */\n\n/**\n * @callback RouterReadyCallback\n * @param {Router} router - The router instance.\n * @returns {void | Promise<void>}\n * @description Callback for `router:ready` event.\n */\n\n/**\n * @callback RouteAddedCallback\n * @param {RouteDefinition} route - The added route definition.\n * @returns {void | Promise<void>}\n * @description Callback for `router:routeAdded` event.\n */\n\n/**\n * @callback RouteRemovedCallback\n * @param {RouteDefinition} route - The removed route definition.\n * @returns {void | Promise<void>}\n * @description Callback for `router:routeRemoved` event.\n */\n\n// ============================================\n// Core Type Definitions (continued)\n// ============================================\n\n/**\n * Simple error handler for the core router.\n * Can be overridden by error handling plugins.\n * Provides consistent error formatting and logging for router operations.\n * @private\n */\nconst CoreErrorHandler = {\n  /**\n   * Handles router errors with basic formatting.\n   * @param {Error} error - The error to handle.\n   * @param {string} context - The context where the error occurred.\n   * @param {Object} details - Additional error details.\n   * @throws {Error} The formatted error.\n   */\n  handle(error, context, details = {}) {\n    const message = `[ElevaRouter] ${context}: ${error.message}`;\n    const formattedError = new Error(message);\n\n    // Preserve original error details\n    formattedError.originalError = error;\n    formattedError.context = context;\n    formattedError.details = details;\n\n    console.error(message, { error, context, details });\n    throw formattedError;\n  },\n\n  /**\n   * Logs a warning without throwing an error.\n   * @param {string} message - The warning message.\n   * @param {Object} details - Additional warning details.\n   */\n  warn(message, details = {}) {\n    console.warn(`[ElevaRouter] ${message}`, details);\n  },\n\n  /**\n   * Logs an error without throwing.\n   * @param {string} message - The error message.\n   * @param {Error} error - The original error.\n   * @param {Object} details - Additional error details.\n   */\n  log(message, error, details = {}) {\n    console.error(`[ElevaRouter] ${message}`, { error, details });\n  },\n};\n\n/**\n * @typedef {Object} RouteLocation\n * @property {string} path - The path of the route (e.g., '/users/123').\n * @property {Record<string, string>} query - Query parameters as key-value pairs.\n * @property {string} fullUrl - The complete URL including hash, path, and query string.\n * @property {Record<string, string>} params - Dynamic route parameters (e.g., `{ id: '123' }`).\n * @property {RouteMeta} meta - Metadata associated with the matched route.\n * @property {string} [name] - The optional name of the matched route.\n * @property {RouteDefinition} matched - The raw route definition object that was matched.\n * @description Represents the current or target location in the router.\n */\n\n/**\n * @typedef {boolean | string | NavigationTarget | void} NavigationGuardResult\n * The return value of a navigation guard.\n * - `true` or `undefined/void`: Allow navigation\n * - `false`: Abort navigation\n * - `string`: Redirect to path\n * - `NavigationTarget`: Redirect with options\n */\n\n/**\n * @callback NavigationGuard\n * @param {RouteLocation} to - The target route location.\n * @param {RouteLocation | null} from - The source route location (null on initial navigation).\n * @returns {NavigationGuardResult | Promise<NavigationGuardResult>}\n * @description A function that controls navigation flow. Runs before navigation is confirmed.\n * @example\n * // Simple auth guard\n * const authGuard = (to, from) => {\n *   if (to.meta.requiresAuth && !isLoggedIn()) {\n *     return '/login'; // Redirect\n *   }\n *   // Allow navigation (implicit return undefined)\n * };\n */\n\n/**\n * @callback NavigationHook\n * @param {RouteLocation} to - The target route location.\n * @param {RouteLocation | null} from - The source route location.\n * @returns {void | Promise<void>}\n * @description A lifecycle hook for side effects. Does not affect navigation flow.\n * @example\n * // Analytics hook\n * const analyticsHook = (to, from) => {\n *   analytics.trackPageView(to.path);\n * };\n */\n\n/**\n * @typedef {Object} RouterPlugin\n * @property {string} name - Unique plugin identifier.\n * @property {string} [version] - Plugin version (recommended to match router version).\n * @property {(router: Router, options?: Record<string, any>) => void} install - Installation function.\n * @property {(router: Router) => void | Promise<void>} [destroy] - Cleanup function called on router.destroy().\n * @description Interface for router plugins. Plugins can extend router functionality.\n * @example\n * const AnalyticsPlugin = {\n *   name: 'analytics',\n *   version: '1.0.0',\n *   install(router, options) {\n *     router.emitter.on('router:afterEach', (to, from) => {\n *       analytics.track(to.path);\n *     });\n *   }\n * };\n */\n\n/**\n * @typedef {Object} NavigationContext\n * @property {RouteLocation} to - The target route location.\n * @property {RouteLocation | null} from - The source route location.\n * @property {boolean} cancelled - Whether navigation has been cancelled.\n * @property {string | {path: string} | null} redirectTo - Redirect target if navigation should redirect.\n * @description A context object passed to navigation events that plugins can modify to control navigation flow.\n */\n\n/**\n * @typedef {Object} ResolveContext\n * @property {RouteLocation} to - The target route location.\n * @property {RouteLocation | null} from - The source route location.\n * @property {RouteDefinition} route - The matched route definition.\n * @property {ComponentDefinition | null} layoutComponent - The resolved layout component (available in afterResolve).\n * @property {ComponentDefinition | null} pageComponent - The resolved page component (available in afterResolve).\n * @property {boolean} cancelled - Whether navigation has been cancelled.\n * @property {string | {path: string} | null} redirectTo - Redirect target if navigation should redirect.\n * @description A context object passed to component resolution events.\n */\n\n/**\n * @typedef {Object} RenderContext\n * @property {RouteLocation} to - The target route location.\n * @property {RouteLocation | null} from - The source route location.\n * @property {ComponentDefinition | null} layoutComponent - The layout component being rendered.\n * @property {ComponentDefinition} pageComponent - The page component being rendered.\n * @description A context object passed to render events.\n */\n\n/**\n * @typedef {Object} ScrollContext\n * @property {RouteLocation} to - The target route location.\n * @property {RouteLocation | null} from - The source route location.\n * @property {{x: number, y: number} | null} savedPosition - The saved scroll position (if navigating via back/forward).\n * @description A context object passed to scroll events for plugins to handle scroll behavior.\n */\n\n/**\n * @typedef {string | ComponentDefinition | (() => Promise<{default: ComponentDefinition}>)} RouteComponent\n * A component that can be rendered for a route.\n * - `string`: Name of a registered component\n * - `ComponentDefinition`: Inline component definition\n * - `() => Promise<{default: ComponentDefinition}>`: Lazy-loaded component (e.g., `() => import('./Page.js')`)\n */\n\n/**\n * @typedef {Object} RouteDefinition\n * @property {string} path - URL path pattern. Supports:\n *   - Static: `'/about'`\n *   - Dynamic params: `'/users/:id'`\n *   - Wildcard: `'*'` (catch-all, must be last)\n * @property {RouteComponent} component - The component to render for this route.\n * @property {RouteComponent} [layout] - Optional layout component to wrap the route component.\n * @property {string} [name] - Optional route name for programmatic navigation.\n * @property {RouteMeta} [meta] - Optional metadata (auth flags, titles, etc.).\n * @property {NavigationGuard} [beforeEnter] - Route-specific guard before entering.\n * @property {NavigationHook} [afterEnter] - Hook after entering and component is mounted.\n * @property {NavigationGuard} [beforeLeave] - Guard before leaving this route.\n * @property {NavigationHook} [afterLeave] - Hook after leaving and component is unmounted.\n * @property {RouteSegment[]} [segments] - Internal: parsed path segments (added by router).\n * @description Defines a route in the application.\n * @example\n * // Static route\n * { path: '/about', component: AboutPage }\n *\n * // Dynamic route with params\n * { path: '/users/:id', component: UserPage, meta: { requiresAuth: true } }\n *\n * // Lazy-loaded route with layout\n * {\n *   path: '/dashboard',\n *   component: () => import('./Dashboard.js'),\n *   layout: DashboardLayout,\n *   beforeEnter: (to, from) => isLoggedIn() || '/login'\n * }\n *\n * // Catch-all 404 route (must be last)\n * { path: '*', component: NotFoundPage }\n */\n\n/**\n * @class Router\n * @classdesc A powerful, reactive, and flexible Router Plugin for Eleva.\n * This class manages all routing logic, including state, navigation, and rendering.\n *\n * ## Features\n * - Multiple routing modes (hash, history, query)\n * - Reactive route state via Signals\n * - Navigation guards and lifecycle hooks\n * - Lazy-loaded components\n * - Layout system\n * - Plugin architecture\n * - Scroll position management\n *\n * ## Events Reference\n * | Event | Callback Type | Can Block | Description |\n * |-------|--------------|-----------|-------------|\n * | `router:ready` | {@link RouterReadyCallback} | No | Router initialized |\n * | `router:beforeEach` | {@link NavigationContextCallback} | Yes | Before guards run |\n * | `router:beforeResolve` | {@link ResolveContextCallback} | Yes | Before component loading |\n * | `router:afterResolve` | {@link ResolveContextCallback} | No | After components loaded |\n * | `router:afterLeave` | {@link RouteChangeCallback} | No | After leaving route |\n * | `router:beforeRender` | {@link RenderContextCallback} | No | Before DOM update |\n * | `router:afterRender` | {@link RenderContextCallback} | No | After DOM update |\n * | `router:scroll` | {@link ScrollContextCallback} | No | For scroll behavior |\n * | `router:afterEnter` | {@link RouteChangeCallback} | No | After entering route |\n * | `router:afterEach` | {@link RouteChangeCallback} | No | Navigation complete |\n * | `router:onError` | {@link RouterErrorCallback} | No | Navigation error |\n * | `router:routeAdded` | {@link RouteAddedCallback} | No | Dynamic route added |\n * | `router:routeRemoved` | {@link RouteRemovedCallback} | No | Dynamic route removed |\n *\n * ## Reactive Signals\n * - `currentRoute: Signal<RouteLocation | null>` - Current route info\n * - `previousRoute: Signal<RouteLocation | null>` - Previous route info\n * - `currentParams: Signal<Record<string, string>>` - Current route params\n * - `currentQuery: Signal<Record<string, string>>` - Current query params\n * - `currentLayout: Signal<MountResult | null>` - Mounted layout instance\n * - `currentView: Signal<MountResult | null>` - Mounted view instance\n * - `isReady: Signal<boolean>` - Router readiness state\n *\n * @note Internal API Access Policy:\n * As a core Eleva plugin, the Router may access internal Eleva APIs (prefixed with _)\n * such as `eleva._components`. This is intentional and these internal APIs are\n * considered stable for official plugins. Third-party plugins should avoid\n * accessing internal APIs as they may change without notice.\n *\n * @example\n * // Basic setup\n * const router = new Router(eleva, {\n *   mode: 'hash',\n *   mount: '#app',\n *   routes: [\n *     { path: '/', component: HomePage },\n *     { path: '/users/:id', component: UserPage },\n *     { path: '*', component: NotFoundPage }\n *   ]\n * });\n *\n * // Start router\n * await router.start();\n *\n * // Navigate programmatically\n * const success = await router.navigate('/users/123');\n *\n * // Watch for route changes\n * router.currentRoute.watch((route) => {\n *   document.title = route?.meta?.title || 'My App';\n * });\n *\n * @private\n */\nclass Router {\n  /**\n   * Creates an instance of the Router.\n   * @param {Eleva} eleva - The Eleva framework instance.\n   * @param {RouterOptions} options - The configuration options for the router.\n   */\n  constructor(eleva, options = {}) {\n    /** @type {Eleva} The Eleva framework instance. */\n    this.eleva = eleva;\n\n    /** @type {RouterOptions} The merged router options. */\n    this.options = {\n      mode: \"hash\",\n      queryParam: \"view\",\n      viewSelector: \"root\",\n      ...options,\n    };\n\n    /** @private @type {RouteDefinition[]} The processed list of route definitions. */\n    this.routes = this._processRoutes(options.routes || []);\n\n    /** @private @type {import('eleva').Emitter} The shared Eleva event emitter for global hooks. */\n    this.emitter = this.eleva.emitter;\n\n    /** @private @type {boolean} A flag indicating if the router has been started. */\n    this.isStarted = false;\n\n    /** @private @type {boolean} A flag to prevent navigation loops from history events. */\n    this._isNavigating = false;\n\n    /** @private @type {number} Counter for tracking navigation operations to prevent race conditions. */\n    this._navigationId = 0;\n\n    /** @private @type {Array<() => void>} A collection of cleanup functions for event listeners. */\n    this.eventListeners = [];\n\n    /** @type {Signal<RouteLocation | null>} A reactive signal holding the current route's information. */\n    this.currentRoute = new this.eleva.signal(null);\n\n    /** @type {Signal<RouteLocation | null>} A reactive signal holding the previous route's information. */\n    this.previousRoute = new this.eleva.signal(null);\n\n    /** @type {Signal<Object<string, string>>} A reactive signal holding the current route's parameters. */\n    this.currentParams = new this.eleva.signal({});\n\n    /** @type {Signal<Object<string, string>>} A reactive signal holding the current route's query parameters. */\n    this.currentQuery = new this.eleva.signal({});\n\n    /** @type {Signal<import('eleva').MountResult | null>} A reactive signal for the currently mounted layout instance. */\n    this.currentLayout = new this.eleva.signal(null);\n\n    /** @type {Signal<import('eleva').MountResult | null>} A reactive signal for the currently mounted view (page) instance. */\n    this.currentView = new this.eleva.signal(null);\n\n    /** @type {Signal<boolean>} A reactive signal indicating if the router is ready (started and initial navigation complete). */\n    this.isReady = new this.eleva.signal(false);\n\n    /** @private @type {Map<string, RouterPlugin>} Map of registered plugins by name. */\n    this.plugins = new Map();\n\n    /** @private @type {Array<NavigationGuard>} Array of global before-each navigation guards. */\n    this._beforeEachGuards = [];\n\n    // If onBeforeEach was provided in options, add it to the guards array\n    if (options.onBeforeEach) {\n      this._beforeEachGuards.push(options.onBeforeEach);\n    }\n\n    /** @type {Object} The error handler instance. Can be overridden by plugins. */\n    this.errorHandler = CoreErrorHandler;\n\n    /** @private @type {Map<string, {x: number, y: number}>} Saved scroll positions by route path. */\n    this._scrollPositions = new Map();\n\n    this._validateOptions();\n  }\n\n  /**\n   * Validates the provided router options.\n   * @private\n   * @throws {Error} If the routing mode is invalid.\n   */\n  _validateOptions() {\n    if (![\"hash\", \"query\", \"history\"].includes(this.options.mode)) {\n      this.errorHandler.handle(\n        new Error(\n          `Invalid routing mode: ${this.options.mode}. Must be \"hash\", \"query\", or \"history\".`\n        ),\n        \"Configuration validation failed\"\n      );\n    }\n  }\n\n  /**\n   * Pre-processes route definitions to parse their path segments for efficient matching.\n   * @private\n   * @param {RouteDefinition[]} routes - The raw route definitions.\n   * @returns {RouteDefinition[]} The processed routes.\n   */\n  _processRoutes(routes) {\n    const processedRoutes = [];\n    for (const route of routes) {\n      try {\n        processedRoutes.push({\n          ...route,\n          segments: this._parsePathIntoSegments(route.path),\n        });\n      } catch (error) {\n        this.errorHandler.warn(\n          `Invalid path in route definition \"${route.path || \"undefined\"}\": ${error.message}`,\n          { route, error }\n        );\n      }\n    }\n    return processedRoutes;\n  }\n\n  /**\n   * Parses a route path string into an array of static and parameter segments.\n   * @private\n   * @param {string} path - The path pattern to parse.\n   * @returns {Array<{type: 'static' | 'param', value?: string, name?: string}>} An array of segment objects.\n   * @throws {Error} If the route path is not a valid string.\n   */\n  _parsePathIntoSegments(path) {\n    if (!path || typeof path !== \"string\") {\n      this.errorHandler.handle(\n        new Error(\"Route path must be a non-empty string\"),\n        \"Path parsing failed\",\n        { path }\n      );\n    }\n\n    const normalizedPath = path.replace(/\\/+/g, \"/\").replace(/\\/$/, \"\") || \"/\";\n\n    if (normalizedPath === \"/\") {\n      return [];\n    }\n\n    return normalizedPath\n      .split(\"/\")\n      .filter(Boolean)\n      .map((segment) => {\n        if (segment.startsWith(\":\")) {\n          const paramName = segment.substring(1);\n          if (!paramName) {\n            this.errorHandler.handle(\n              new Error(`Invalid parameter segment: ${segment}`),\n              \"Path parsing failed\",\n              { segment, path }\n            );\n          }\n          return { type: \"param\", name: paramName };\n        }\n        return { type: \"static\", value: segment };\n      });\n  }\n\n  /**\n   * Finds the view element within a container using multiple selector strategies.\n   * @private\n   * @param {HTMLElement} container - The parent element to search within.\n   * @returns {HTMLElement} The found view element or the container itself as a fallback.\n   */\n  _findViewElement(container) {\n    const selector = this.options.viewSelector;\n    return (\n      container.querySelector(`#${selector}`) ||\n      container.querySelector(`.${selector}`) ||\n      container.querySelector(`[data-${selector}]`) ||\n      container.querySelector(selector) ||\n      container\n    );\n  }\n\n  /**\n   * Starts the router, initializes event listeners, and performs the initial navigation.\n   * @returns {Promise<Router>} The router instance for method chaining.\n   *\n   * @example\n   * // Basic usage\n   * await router.start();\n   *\n   * // Method chaining\n   * await router.start().then(r => r.navigate('/home'));\n   *\n   * // Reactive readiness\n   * router.isReady.watch((ready) => {\n   *   if (ready) console.log('Router is ready!');\n   * });\n   */\n  async start() {\n    if (this.isStarted) {\n      this.errorHandler.warn(\"Router is already started\");\n      return this;\n    }\n    if (typeof window === \"undefined\") {\n      this.errorHandler.warn(\n        \"Router start skipped: `window` object not available (SSR environment)\"\n      );\n      return this;\n    }\n    if (\n      typeof document !== \"undefined\" &&\n      !document.querySelector(this.options.mount)\n    ) {\n      this.errorHandler.warn(\n        `Mount element \"${this.options.mount}\" was not found in the DOM. The router will not start.`,\n        { mountSelector: this.options.mount }\n      );\n      return this;\n    }\n    const handler = () => this._handleRouteChange();\n    if (this.options.mode === \"hash\") {\n      window.addEventListener(\"hashchange\", handler);\n      this.eventListeners.push(() =>\n        window.removeEventListener(\"hashchange\", handler)\n      );\n    } else {\n      window.addEventListener(\"popstate\", handler);\n      this.eventListeners.push(() =>\n        window.removeEventListener(\"popstate\", handler)\n      );\n    }\n    this.isStarted = true;\n    // Initial navigation is not a popstate event\n    await this._handleRouteChange(false);\n    // Set isReady to true after initial navigation completes\n    this.isReady.value = true;\n    await this.emitter.emit(\"router:ready\", this);\n    return this;\n  }\n\n  /**\n   * Stops the router and cleans up all event listeners and mounted components.\n   * @returns {Promise<void>}\n   */\n  async destroy() {\n    if (!this.isStarted) return;\n\n    // Clean up plugins\n    for (const plugin of this.plugins.values()) {\n      if (typeof plugin.destroy === \"function\") {\n        try {\n          await plugin.destroy(this);\n        } catch (error) {\n          this.errorHandler.log(`Plugin ${plugin.name} destroy failed`, error);\n        }\n      }\n    }\n\n    this.eventListeners.forEach((cleanup) => cleanup());\n    this.eventListeners = [];\n    if (this.currentLayout.value) {\n      await this.currentLayout.value.unmount();\n    }\n    this.isStarted = false;\n    this.isReady.value = false;\n  }\n\n  /**\n   * Alias for destroy(). Stops the router and cleans up all resources.\n   * Provided for semantic consistency (start/stop pattern).\n   * @returns {Promise<void>}\n   *\n   * @example\n   * await router.start();\n   * // ... later\n   * await router.stop();\n   */\n  async stop() {\n    return this.destroy();\n  }\n\n  /**\n   * Programmatically navigates to a new route.\n   * @param {string | NavigationTarget} location - The target location as a path string or navigation target object.\n   * @param {Record<string, string>} [params] - Route parameters (only used when location is a string).\n   * @returns {Promise<boolean>} True if navigation succeeded, false if blocked by guards or failed.\n   *\n   * @example\n   * // Basic navigation\n   * await router.navigate('/users/123');\n   *\n   * // Check if navigation succeeded\n   * const success = await router.navigate('/protected');\n   * if (!success) {\n   *   console.log('Navigation was blocked by a guard');\n   * }\n   *\n   * // Navigate with options\n   * await router.navigate({\n   *   path: '/users/:id',\n   *   params: { id: '123' },\n   *   query: { tab: 'profile' },\n   *   replace: true\n   * });\n   */\n  async navigate(location, params = {}) {\n    try {\n      const target =\n        typeof location === \"string\" ? { path: location, params } : location;\n      let path = this._buildPath(target.path, target.params || {});\n      const query = target.query || {};\n\n      if (Object.keys(query).length > 0) {\n        const queryString = new URLSearchParams(query).toString();\n        if (queryString) path += `?${queryString}`;\n      }\n\n      if (this._isSameRoute(path, target.params, query)) {\n        return true; // Already at this route, consider it successful\n      }\n\n      const navigationSuccessful = await this._proceedWithNavigation(path);\n\n      if (navigationSuccessful) {\n        // Increment navigation ID and capture it for this navigation\n        const currentNavId = ++this._navigationId;\n        this._isNavigating = true;\n\n        const state = target.state || {};\n        const replace = target.replace || false;\n        const historyMethod = replace ? \"replaceState\" : \"pushState\";\n\n        if (this.options.mode === \"hash\") {\n          if (replace) {\n            const newUrl = `${window.location.pathname}${window.location.search}#${path}`;\n            window.history.replaceState(state, \"\", newUrl);\n          } else {\n            window.location.hash = path;\n          }\n        } else {\n          const url =\n            this.options.mode === \"query\" ? this._buildQueryUrl(path) : path;\n          history[historyMethod](state, \"\", url);\n        }\n\n        // Only reset the flag if no newer navigation has started\n        queueMicrotask(() => {\n          if (this._navigationId === currentNavId) {\n            this._isNavigating = false;\n          }\n        });\n      }\n\n      return navigationSuccessful;\n    } catch (error) {\n      this.errorHandler.log(\"Navigation failed\", error);\n      await this.emitter.emit(\"router:onError\", error);\n      return false;\n    }\n  }\n\n  /**\n   * Builds a URL for query mode.\n   * @private\n   * @param {string} path - The path to set as the query parameter.\n   * @returns {string} The full URL with the updated query string.\n   */\n  _buildQueryUrl(path) {\n    const urlParams = new URLSearchParams(window.location.search);\n    urlParams.set(this.options.queryParam, path.split(\"?\")[0]);\n    return `${window.location.pathname}?${urlParams.toString()}`;\n  }\n\n  /**\n   * Checks if the target route is identical to the current route.\n   * @private\n   * @param {string} path - The target path with query string.\n   * @param {object} params - The target params.\n   * @param {object} query - The target query.\n   * @returns {boolean} - True if the routes are the same.\n   */\n  _isSameRoute(path, params, query) {\n    const current = this.currentRoute.value;\n    if (!current) return false;\n    const [targetPath, queryString] = path.split(\"?\");\n    const targetQuery = query || this._parseQuery(queryString || \"\");\n    return (\n      current.path === targetPath &&\n      JSON.stringify(current.params) === JSON.stringify(params || {}) &&\n      JSON.stringify(current.query) === JSON.stringify(targetQuery)\n    );\n  }\n\n  /**\n   * Injects dynamic parameters into a path string.\n   * @private\n   */\n  _buildPath(path, params) {\n    let result = path;\n    for (const [key, value] of Object.entries(params)) {\n      // Fix: Handle special characters and ensure proper encoding\n      const encodedValue = encodeURIComponent(String(value));\n      result = result.replace(new RegExp(`:${key}\\\\b`, \"g\"), encodedValue);\n    }\n    return result;\n  }\n\n  /**\n   * The handler for browser-initiated route changes (e.g., back/forward buttons).\n   * @private\n   * @param {boolean} [isPopState=true] - Whether this is a popstate event (back/forward navigation).\n   */\n  async _handleRouteChange(isPopState = true) {\n    if (this._isNavigating) return;\n\n    try {\n      const from = this.currentRoute.value;\n      const toLocation = this._getCurrentLocation();\n\n      const navigationSuccessful = await this._proceedWithNavigation(\n        toLocation.fullUrl,\n        isPopState\n      );\n\n      // If navigation was blocked by a guard, revert the URL change\n      if (!navigationSuccessful && from) {\n        this.navigate({ path: from.path, query: from.query, replace: true });\n      }\n    } catch (error) {\n      this.errorHandler.log(\"Route change handling failed\", error, {\n        currentUrl: typeof window !== \"undefined\" ? window.location.href : \"\",\n      });\n      await this.emitter.emit(\"router:onError\", error);\n    }\n  }\n\n  /**\n   * Manages the core navigation lifecycle. Runs guards before committing changes.\n   * Emits lifecycle events that plugins can hook into:\n   * - router:beforeEach - Before guards run (can block/redirect via context)\n   * - router:beforeResolve - Before component resolution (can block/redirect)\n   * - router:afterResolve - After components are resolved\n   * - router:beforeRender - Before DOM rendering\n   * - router:afterRender - After DOM rendering\n   * - router:scroll - After render, for scroll behavior\n   * - router:afterEnter - After entering a route\n   * - router:afterLeave - After leaving a route\n   * - router:afterEach - After navigation completes\n   *\n   * @private\n   * @param {string} fullPath - The full path (e.g., '/users/123?foo=bar') to navigate to.\n   * @param {boolean} [isPopState=false] - Whether this navigation was triggered by popstate (back/forward).\n   * @returns {Promise<boolean>} - `true` if navigation succeeded, `false` if aborted.\n   */\n  async _proceedWithNavigation(fullPath, isPopState = false) {\n    const from = this.currentRoute.value;\n    const [path, queryString] = (fullPath || \"/\").split(\"?\");\n    const toLocation = {\n      path: path.startsWith(\"/\") ? path : `/${path}`,\n      query: this._parseQuery(queryString),\n      fullUrl: fullPath,\n    };\n\n    let toMatch = this._matchRoute(toLocation.path);\n\n    if (!toMatch) {\n      const notFoundRoute = this.routes.find((route) => route.path === \"*\");\n      if (notFoundRoute) {\n        toMatch = {\n          route: notFoundRoute,\n          params: {\n            pathMatch: decodeURIComponent(toLocation.path.substring(1)),\n          },\n        };\n      } else {\n        await this.emitter.emit(\n          \"router:onError\",\n          new Error(`Route not found: ${toLocation.path}`),\n          toLocation,\n          from\n        );\n        return false;\n      }\n    }\n\n    const to = {\n      ...toLocation,\n      params: toMatch.params,\n      meta: toMatch.route.meta || {},\n      name: toMatch.route.name,\n      matched: toMatch.route,\n    };\n\n    try {\n      // 1. Run all *pre-navigation* guards.\n      const canNavigate = await this._runGuards(to, from, toMatch.route);\n      if (!canNavigate) return false;\n\n      // 2. Save current scroll position before navigating away\n      if (from && typeof window !== \"undefined\") {\n        this._scrollPositions.set(from.path, {\n          x: window.scrollX || window.pageXOffset || 0,\n          y: window.scrollY || window.pageYOffset || 0,\n        });\n      }\n\n      // 3. Emit beforeResolve event - plugins can show loading indicators\n      /** @type {ResolveContext} */\n      const resolveContext = {\n        to,\n        from,\n        route: toMatch.route,\n        layoutComponent: null,\n        pageComponent: null,\n        cancelled: false,\n        redirectTo: null,\n      };\n      await this.emitter.emit(\"router:beforeResolve\", resolveContext);\n\n      // Check if resolution was cancelled or redirected\n      if (resolveContext.cancelled) return false;\n      if (resolveContext.redirectTo) {\n        this.navigate(resolveContext.redirectTo);\n        return false;\n      }\n\n      // 4. Resolve async components *before* touching the DOM.\n      const { layoutComponent, pageComponent } = await this._resolveComponents(\n        toMatch.route\n      );\n\n      // 5. Emit afterResolve event - plugins can hide loading indicators\n      resolveContext.layoutComponent = layoutComponent;\n      resolveContext.pageComponent = pageComponent;\n      await this.emitter.emit(\"router:afterResolve\", resolveContext);\n\n      // 6. Unmount the previous view/layout.\n      if (from) {\n        const toLayout = toMatch.route.layout || this.options.globalLayout;\n        const fromLayout = from.matched.layout || this.options.globalLayout;\n\n        const tryUnmount = async (instance) => {\n          if (!instance) return;\n\n          try {\n            await instance.unmount();\n          } catch (error) {\n            this.errorHandler.warn(\"Error during component unmount\", {\n              error,\n              instance,\n            });\n          }\n        };\n\n        if (toLayout !== fromLayout) {\n          await tryUnmount(this.currentLayout.value);\n          this.currentLayout.value = null;\n        } else {\n          await tryUnmount(this.currentView.value);\n          this.currentView.value = null;\n        }\n\n        // Call `afterLeave` hook *after* the old component has been unmounted.\n        if (from.matched.afterLeave) {\n          await from.matched.afterLeave(to, from);\n        }\n        await this.emitter.emit(\"router:afterLeave\", to, from);\n      }\n\n      // 7. Update reactive state.\n      this.previousRoute.value = from;\n      this.currentRoute.value = to;\n      this.currentParams.value = to.params || {};\n      this.currentQuery.value = to.query || {};\n\n      // 8. Emit beforeRender event - plugins can add transitions\n      /** @type {RenderContext} */\n      const renderContext = {\n        to,\n        from,\n        layoutComponent,\n        pageComponent,\n      };\n      await this.emitter.emit(\"router:beforeRender\", renderContext);\n\n      // 9. Render the new components.\n      await this._render(layoutComponent, pageComponent, to);\n\n      // 10. Emit afterRender event - plugins can trigger animations\n      await this.emitter.emit(\"router:afterRender\", renderContext);\n\n      // 11. Emit scroll event - plugins can handle scroll restoration\n      /** @type {ScrollContext} */\n      const scrollContext = {\n        to,\n        from,\n        savedPosition: isPopState\n          ? this._scrollPositions.get(to.path) || null\n          : null,\n      };\n      await this.emitter.emit(\"router:scroll\", scrollContext);\n\n      // 12. Run post-navigation hooks.\n      if (toMatch.route.afterEnter) {\n        await toMatch.route.afterEnter(to, from);\n      }\n      await this.emitter.emit(\"router:afterEnter\", to, from);\n      await this.emitter.emit(\"router:afterEach\", to, from);\n\n      return true;\n    } catch (error) {\n      this.errorHandler.log(\"Error during navigation\", error, { to, from });\n      await this.emitter.emit(\"router:onError\", error, to, from);\n      return false;\n    }\n  }\n\n  /**\n   * Executes all applicable navigation guards for a transition in order.\n   * Guards are executed in the following order:\n   * 1. Global beforeEach event (emitter-based, can block via context)\n   * 2. Global beforeEach guards (registered via onBeforeEach)\n   * 3. Route-specific beforeLeave guard (from the route being left)\n   * 4. Route-specific beforeEnter guard (from the route being entered)\n   *\n   * @private\n   * @param {RouteLocation} to - The target route location.\n   * @param {RouteLocation | null} from - The current route location (null on initial navigation).\n   * @param {RouteDefinition} route - The matched route definition.\n   * @returns {Promise<boolean>} - `false` if navigation should be aborted.\n   */\n  async _runGuards(to, from, route) {\n    // Create navigation context that plugins can modify to block navigation\n    /** @type {NavigationContext} */\n    const navContext = {\n      to,\n      from,\n      cancelled: false,\n      redirectTo: null,\n    };\n\n    // Emit beforeEach event with context - plugins can block by modifying context\n    await this.emitter.emit(\"router:beforeEach\", navContext);\n\n    // Check if navigation was cancelled or redirected by event listeners\n    if (navContext.cancelled) return false;\n    if (navContext.redirectTo) {\n      this.navigate(navContext.redirectTo);\n      return false;\n    }\n\n    // Collect all guards in execution order\n    const guards = [\n      ...this._beforeEachGuards,\n      ...(from && from.matched.beforeLeave ? [from.matched.beforeLeave] : []),\n      ...(route.beforeEnter ? [route.beforeEnter] : []),\n    ];\n\n    for (const guard of guards) {\n      const result = await guard(to, from);\n      if (result === false) return false;\n      if (typeof result === \"string\" || typeof result === \"object\") {\n        this.navigate(result);\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * Resolves a string component definition to a component object.\n   * @private\n   * @param {string} def - The component name to resolve.\n   * @returns {ComponentDefinition} The resolved component.\n   * @throws {Error} If the component is not registered.\n   *\n   * @note Core plugins (Router, Attr, Props, Store) may access eleva._components\n   * directly. This is intentional and stable for official Eleva plugins shipped\n   * with the framework. Third-party plugins should use eleva.component() for\n   * registration and avoid direct access to internal APIs.\n   */\n  _resolveStringComponent(def) {\n    const componentDef = this.eleva._components.get(def);\n    if (!componentDef) {\n      this.errorHandler.handle(\n        new Error(`Component \"${def}\" not registered.`),\n        \"Component resolution failed\",\n        {\n          componentName: def,\n          availableComponents: Array.from(this.eleva._components.keys()),\n        }\n      );\n    }\n    return componentDef;\n  }\n\n  /**\n   * Resolves a function component definition to a component object.\n   * @private\n   * @param {Function} def - The function to resolve.\n   * @returns {Promise<ComponentDefinition>} The resolved component.\n   * @throws {Error} If the function fails to load the component.\n   */\n  async _resolveFunctionComponent(def) {\n    try {\n      const funcStr = def.toString();\n      const isAsyncImport =\n        funcStr.includes(\"import(\") || funcStr.startsWith(\"() =>\");\n\n      const result = await def();\n      return isAsyncImport ? result.default || result : result;\n    } catch (error) {\n      this.errorHandler.handle(\n        new Error(`Failed to load async component: ${error.message}`),\n        \"Component resolution failed\",\n        { function: def.toString(), error }\n      );\n    }\n  }\n\n  /**\n   * Validates a component definition object.\n   * @private\n   * @param {any} def - The component definition to validate.\n   * @returns {ComponentDefinition} The validated component.\n   * @throws {Error} If the component definition is invalid.\n   */\n  _validateComponentDefinition(def) {\n    if (!def || typeof def !== \"object\") {\n      this.errorHandler.handle(\n        new Error(`Invalid component definition: ${typeof def}`),\n        \"Component validation failed\",\n        { definition: def }\n      );\n    }\n\n    if (\n      typeof def.template !== \"function\" &&\n      typeof def.template !== \"string\"\n    ) {\n      this.errorHandler.handle(\n        new Error(\"Component missing template property\"),\n        \"Component validation failed\",\n        { definition: def }\n      );\n    }\n\n    return def;\n  }\n\n  /**\n   * Resolves a component definition to a component object.\n   * @private\n   * @param {any} def - The component definition to resolve.\n   * @returns {Promise<ComponentDefinition | null>} The resolved component or null.\n   */\n  async _resolveComponent(def) {\n    if (def === null || def === undefined) {\n      return null;\n    }\n\n    if (typeof def === \"string\") {\n      return this._resolveStringComponent(def);\n    }\n\n    if (typeof def === \"function\") {\n      return await this._resolveFunctionComponent(def);\n    }\n\n    if (def && typeof def === \"object\") {\n      return this._validateComponentDefinition(def);\n    }\n\n    this.errorHandler.handle(\n      new Error(`Invalid component definition: ${typeof def}`),\n      \"Component resolution failed\",\n      { definition: def }\n    );\n  }\n\n  /**\n   * Asynchronously resolves the layout and page components for a route.\n   * @private\n   * @param {RouteDefinition} route - The route to resolve components for.\n   * @returns {Promise<{layoutComponent: ComponentDefinition | null, pageComponent: ComponentDefinition}>}\n   */\n  async _resolveComponents(route) {\n    const effectiveLayout = route.layout || this.options.globalLayout;\n\n    try {\n      const [layoutComponent, pageComponent] = await Promise.all([\n        this._resolveComponent(effectiveLayout),\n        this._resolveComponent(route.component),\n      ]);\n\n      if (!pageComponent) {\n        this.errorHandler.handle(\n          new Error(\n            `Page component is null or undefined for route: ${route.path}`\n          ),\n          \"Component resolution failed\",\n          { route: route.path }\n        );\n      }\n\n      return { layoutComponent, pageComponent };\n    } catch (error) {\n      this.errorHandler.log(\n        `Error resolving components for route ${route.path}`,\n        error,\n        { route: route.path }\n      );\n      throw error;\n    }\n  }\n\n  /**\n   * Renders the components for the current route into the DOM.\n   * @private\n   * @param {ComponentDefinition | null} layoutComponent - The pre-loaded layout component.\n   * @param {ComponentDefinition} pageComponent - The pre-loaded page component.\n   */\n  async _render(layoutComponent, pageComponent) {\n    const mountEl = document.querySelector(this.options.mount);\n    if (!mountEl) {\n      this.errorHandler.handle(\n        new Error(`Mount element \"${this.options.mount}\" not found.`),\n        { mountSelector: this.options.mount }\n      );\n    }\n\n    if (layoutComponent) {\n      const layoutInstance = await this.eleva.mount(\n        mountEl,\n        this._wrapComponentWithChildren(layoutComponent)\n      );\n      this.currentLayout.value = layoutInstance;\n      const viewEl = this._findViewElement(layoutInstance.container);\n      const viewInstance = await this.eleva.mount(\n        viewEl,\n        this._wrapComponentWithChildren(pageComponent)\n      );\n      this.currentView.value = viewInstance;\n    } else {\n      const viewInstance = await this.eleva.mount(\n        mountEl,\n        this._wrapComponentWithChildren(pageComponent)\n      );\n      this.currentView.value = viewInstance;\n      this.currentLayout.value = null;\n    }\n  }\n\n  /**\n   * Creates a getter function for router context properties.\n   * @private\n   * @param {string} property - The property name to access.\n   * @param {any} defaultValue - The default value if property is undefined.\n   * @returns {Function} A getter function.\n   */\n  _createRouteGetter(property, defaultValue) {\n    return () => this.currentRoute.value?.[property] ?? defaultValue;\n  }\n\n  /**\n   * Wraps a component definition to inject router-specific context into its setup function.\n   * @private\n   * @param {ComponentDefinition} component - The component to wrap.\n   * @returns {ComponentDefinition} The wrapped component definition.\n   */\n  _wrapComponent(component) {\n    const originalSetup = component.setup;\n    const self = this;\n\n    return {\n      ...component,\n      async setup(ctx) {\n        ctx.router = {\n          navigate: self.navigate.bind(self),\n          current: self.currentRoute,\n          previous: self.previousRoute,\n\n          // Route property getters\n          get params() {\n            return self._createRouteGetter(\"params\", {})();\n          },\n          get query() {\n            return self._createRouteGetter(\"query\", {})();\n          },\n          get path() {\n            return self._createRouteGetter(\"path\", \"/\")();\n          },\n          get fullUrl() {\n            return self._createRouteGetter(\"fullUrl\", window.location.href)();\n          },\n          get meta() {\n            return self._createRouteGetter(\"meta\", {})();\n          },\n        };\n\n        return originalSetup ? await originalSetup(ctx) : {};\n      },\n    };\n  }\n\n  /**\n   * Recursively wraps all child components to ensure they have access to router context.\n   * @private\n   * @param {ComponentDefinition | string} component - The component to wrap (can be a definition object or a registered component name).\n   * @returns {ComponentDefinition | string} The wrapped component definition or the original string reference.\n   */\n  _wrapComponentWithChildren(component) {\n    // If the component is a string (registered component name), return as-is\n    // The router context will be injected when the component is resolved during mounting\n    if (typeof component === \"string\") {\n      return component;\n    }\n\n    // If not a valid component object, return as-is\n    if (!component || typeof component !== \"object\") {\n      return component;\n    }\n\n    const wrappedComponent = this._wrapComponent(component);\n\n    // If the component has children, wrap them too\n    if (\n      wrappedComponent.children &&\n      typeof wrappedComponent.children === \"object\"\n    ) {\n      const wrappedChildren = {};\n      for (const [selector, childComponent] of Object.entries(\n        wrappedComponent.children\n      )) {\n        wrappedChildren[selector] =\n          this._wrapComponentWithChildren(childComponent);\n      }\n      wrappedComponent.children = wrappedChildren;\n    }\n\n    return wrappedComponent;\n  }\n\n  /**\n   * Gets the current location information from the browser's window object.\n   * @private\n   * @returns {Omit<RouteLocation, 'params' | 'meta' | 'name' | 'matched'>}\n   */\n  _getCurrentLocation() {\n    if (typeof window === \"undefined\")\n      return { path: \"/\", query: {}, fullUrl: \"\" };\n    let path, queryString, fullUrl;\n    switch (this.options.mode) {\n      case \"hash\":\n        fullUrl = window.location.hash.slice(1) || \"/\";\n        [path, queryString] = fullUrl.split(\"?\");\n        break;\n      case \"query\":\n        const urlParams = new URLSearchParams(window.location.search);\n        path = urlParams.get(this.options.queryParam) || \"/\";\n        queryString = window.location.search.slice(1);\n        fullUrl = path;\n        break;\n      default: // 'history' mode\n        path = window.location.pathname || \"/\";\n        queryString = window.location.search.slice(1);\n        fullUrl = `${path}${queryString ? \"?\" + queryString : \"\"}`;\n    }\n    return {\n      path: path.startsWith(\"/\") ? path : `/${path}`,\n      query: this._parseQuery(queryString),\n      fullUrl,\n    };\n  }\n\n  /**\n   * Parses a query string into a key-value object.\n   * @private\n   */\n  _parseQuery(queryString) {\n    const query = {};\n    if (queryString) {\n      new URLSearchParams(queryString).forEach((value, key) => {\n        query[key] = value;\n      });\n    }\n    return query;\n  }\n\n  /**\n   * Matches a given path against the registered routes.\n   * @private\n   * @param {string} path - The path to match.\n   * @returns {{route: RouteDefinition, params: Object<string, string>} | null} The matched route and its params, or null.\n   */\n  _matchRoute(path) {\n    const pathSegments = path.split(\"/\").filter(Boolean);\n\n    for (const route of this.routes) {\n      // Handle the root path as a special case.\n      if (route.path === \"/\") {\n        if (pathSegments.length === 0) return { route, params: {} };\n        continue;\n      }\n\n      if (route.segments.length !== pathSegments.length) continue;\n\n      const params = {};\n      let isMatch = true;\n      for (let i = 0; i < route.segments.length; i++) {\n        const routeSegment = route.segments[i];\n        const pathSegment = pathSegments[i];\n        if (routeSegment.type === \"param\") {\n          params[routeSegment.name] = decodeURIComponent(pathSegment);\n        } else if (routeSegment.value !== pathSegment) {\n          isMatch = false;\n          break;\n        }\n      }\n      if (isMatch) return { route, params };\n    }\n    return null;\n  }\n\n  // ============================================\n  // Dynamic Route Management API\n  // ============================================\n\n  /**\n   * Adds a new route dynamically at runtime.\n   * The route will be processed and available for navigation immediately.\n   *\n   * @param {RouteDefinition} route - The route definition to add.\n   * @param {RouteDefinition} [parentRoute] - Optional parent route to add as a child (not yet implemented).\n   * @returns {() => void} A function to remove the added route.\n   *\n   * @example\n   * // Add a route dynamically\n   * const removeRoute = router.addRoute({\n   *   path: '/dynamic',\n   *   component: DynamicPage,\n   *   meta: { title: 'Dynamic Page' }\n   * });\n   *\n   * // Later, remove the route\n   * removeRoute();\n   */\n  addRoute(route, parentRoute = null) {\n    if (!route || !route.path) {\n      this.errorHandler.warn(\"Invalid route definition: missing path\", {\n        route,\n      });\n      return () => {};\n    }\n\n    // Check if route already exists\n    if (this.hasRoute(route.path)) {\n      this.errorHandler.warn(`Route \"${route.path}\" already exists`, { route });\n      return () => {};\n    }\n\n    // Process the route (parse segments)\n    const processedRoute = {\n      ...route,\n      segments: this._parsePathIntoSegments(route.path),\n    };\n\n    // Add to routes array (before wildcard if exists)\n    const wildcardIndex = this.routes.findIndex((r) => r.path === \"*\");\n    if (wildcardIndex !== -1) {\n      this.routes.splice(wildcardIndex, 0, processedRoute);\n    } else {\n      this.routes.push(processedRoute);\n    }\n\n    // Emit event for plugins\n    this.emitter.emit(\"router:routeAdded\", processedRoute);\n\n    // Return removal function\n    return () => this.removeRoute(route.path);\n  }\n\n  /**\n   * Removes a route by its path.\n   *\n   * @param {string} path - The path of the route to remove.\n   * @returns {boolean} True if the route was removed, false if not found.\n   *\n   * @example\n   * router.removeRoute('/dynamic');\n   */\n  removeRoute(path) {\n    const index = this.routes.findIndex((r) => r.path === path);\n    if (index === -1) {\n      return false;\n    }\n\n    const [removedRoute] = this.routes.splice(index, 1);\n\n    // Emit event for plugins\n    this.emitter.emit(\"router:routeRemoved\", removedRoute);\n\n    return true;\n  }\n\n  /**\n   * Checks if a route with the given path exists.\n   *\n   * @param {string} path - The path to check.\n   * @returns {boolean} True if the route exists.\n   *\n   * @example\n   * if (router.hasRoute('/users/:id')) {\n   *   console.log('User route exists');\n   * }\n   */\n  hasRoute(path) {\n    return this.routes.some((r) => r.path === path);\n  }\n\n  /**\n   * Gets all registered routes.\n   *\n   * @returns {RouteDefinition[]} A copy of the routes array.\n   *\n   * @example\n   * const routes = router.getRoutes();\n   * console.log('Available routes:', routes.map(r => r.path));\n   */\n  getRoutes() {\n    return [...this.routes];\n  }\n\n  /**\n   * Gets a route by its path.\n   *\n   * @param {string} path - The path of the route to get.\n   * @returns {RouteDefinition | undefined} The route definition or undefined.\n   *\n   * @example\n   * const route = router.getRoute('/users/:id');\n   * if (route) {\n   *   console.log('Route meta:', route.meta);\n   * }\n   */\n  getRoute(path) {\n    return this.routes.find((r) => r.path === path);\n  }\n\n  // ============================================\n  // Hook Registration Methods\n  // ============================================\n\n  /**\n   * Registers a global pre-navigation guard.\n   * Multiple guards can be registered and will be executed in order.\n   * Guards can also be registered via the emitter using `router:beforeEach` event.\n   *\n   * @param {NavigationGuard} guard - The guard function to register.\n   * @returns {() => void} A function to unregister the guard.\n   *\n   * @example\n   * // Register a guard\n   * const unregister = router.onBeforeEach((to, from) => {\n   *   if (to.meta.requiresAuth && !isAuthenticated()) {\n   *     return '/login';\n   *   }\n   * });\n   *\n   * // Later, unregister the guard\n   * unregister();\n   */\n  onBeforeEach(guard) {\n    this._beforeEachGuards.push(guard);\n    return () => {\n      const index = this._beforeEachGuards.indexOf(guard);\n      if (index > -1) {\n        this._beforeEachGuards.splice(index, 1);\n      }\n    };\n  }\n  /**\n   * Registers a global hook that runs after a new route component has been mounted.\n   * @param {NavigationHook} hook - The hook function to register.\n   * @returns {() => void} A function to unregister the hook.\n   */\n  onAfterEnter(hook) {\n    return this.emitter.on(\"router:afterEnter\", hook);\n  }\n\n  /**\n   * Registers a global hook that runs after a route component has been unmounted.\n   * @param {NavigationHook} hook - The hook function to register.\n   * @returns {() => void} A function to unregister the hook.\n   */\n  onAfterLeave(hook) {\n    return this.emitter.on(\"router:afterLeave\", hook);\n  }\n\n  /**\n   * Registers a global hook that runs after a navigation has been confirmed and all hooks have completed.\n   * @param {NavigationHook} hook - The hook function to register.\n   * @returns {() => void} A function to unregister the hook.\n   */\n  onAfterEach(hook) {\n    return this.emitter.on(\"router:afterEach\", hook);\n  }\n\n  /**\n   * Registers a global error handler for navigation errors.\n   * @param {(error: Error, to?: RouteLocation, from?: RouteLocation) => void} handler - The error handler function.\n   * @returns {() => void} A function to unregister the handler.\n   */\n  onError(handler) {\n    return this.emitter.on(\"router:onError\", handler);\n  }\n\n  /**\n   * Registers a plugin with the router.\n   * @param {RouterPlugin} plugin - The plugin to register.\n   */\n  use(plugin, options = {}) {\n    if (typeof plugin.install !== \"function\") {\n      this.errorHandler.handle(\n        new Error(\"Plugin must have an install method\"),\n        \"Plugin registration failed\",\n        { plugin }\n      );\n    }\n\n    // Check if plugin is already registered\n    if (this.plugins.has(plugin.name)) {\n      this.errorHandler.warn(`Plugin \"${plugin.name}\" is already registered`, {\n        existingPlugin: this.plugins.get(plugin.name),\n      });\n      return;\n    }\n\n    this.plugins.set(plugin.name, plugin);\n    plugin.install(this, options);\n  }\n\n  /**\n   * Gets all registered plugins.\n   * @returns {RouterPlugin[]} Array of registered plugins.\n   */\n  getPlugins() {\n    return Array.from(this.plugins.values());\n  }\n\n  /**\n   * Gets a plugin by name.\n   * @param {string} name - The plugin name.\n   * @returns {RouterPlugin | undefined} The plugin or undefined.\n   */\n  getPlugin(name) {\n    return this.plugins.get(name);\n  }\n\n  /**\n   * Removes a plugin from the router.\n   * @param {string} name - The plugin name.\n   * @returns {boolean} True if the plugin was removed.\n   */\n  removePlugin(name) {\n    const plugin = this.plugins.get(name);\n    if (!plugin) return false;\n\n    // Call destroy if available\n    if (typeof plugin.destroy === \"function\") {\n      try {\n        plugin.destroy(this);\n      } catch (error) {\n        this.errorHandler.log(`Plugin ${name} destroy failed`, error);\n      }\n    }\n\n    return this.plugins.delete(name);\n  }\n\n  /**\n   * Sets a custom error handler. Used by error handling plugins.\n   * @param {Object} errorHandler - The error handler object with handle, warn, and log methods.\n   */\n  setErrorHandler(errorHandler) {\n    if (\n      errorHandler &&\n      typeof errorHandler.handle === \"function\" &&\n      typeof errorHandler.warn === \"function\" &&\n      typeof errorHandler.log === \"function\"\n    ) {\n      this.errorHandler = errorHandler;\n    } else {\n      console.warn(\n        \"[ElevaRouter] Invalid error handler provided. Must have handle, warn, and log methods.\"\n      );\n    }\n  }\n}\n\n/**\n * @typedef {Object} RouterOptions\n * @property {string} mount - A CSS selector for the main element where the app is mounted.\n * @property {RouteDefinition[]} routes - An array of route definitions.\n * @property {'hash' | 'query' | 'history'} [mode='hash'] - The routing mode.\n * @property {string} [queryParam='page'] - The query parameter to use in 'query' mode.\n * @property {string} [viewSelector='view'] - The selector for the view element within a layout.\n * @property {boolean} [autoStart=true] - Whether to start the router automatically.\n * @property {NavigationGuard} [onBeforeEach] - A global guard executed before every navigation.\n * @property {string | ComponentDefinition | (() => Promise<{default: ComponentDefinition}>)} [globalLayout] - A global layout for all routes. Can be overridden by a route's specific layout.\n */\n\n/**\n * @class  RouterPlugin\n * @classdesc A powerful, reactive, and flexible Router Plugin for Eleva applications.\n * This plugin provides comprehensive client-side routing functionality including:\n * - Multiple routing modes (hash, history, query)\n * - Navigation guards and lifecycle hooks\n * - Reactive state management\n * - Component resolution and lazy loading\n * - Layout and page component separation\n * - Plugin system for extensibility\n * - Advanced error handling\n *\n * @example\n * // Install the plugin\n * const app = new Eleva(\"myApp\");\n *\n * const HomePage = { template: () => `<h1>Home</h1>` };\n * const AboutPage = { template: () => `<h1>About Us</h1>` };\n * const UserPage = {\n *   template: (ctx) => `<h1>User: ${ctx.router.params.id}</h1>`\n * };\n *\n * app.use(RouterPlugin, {\n *   mount: '#app',\n *   mode: 'hash',\n *   routes: [\n *     { path: '/', component: HomePage },\n *     { path: '/about', component: AboutPage },\n *     { path: '/users/:id', component: UserPage }\n *   ]\n * });\n */\nexport const RouterPlugin = {\n  /**\n   * Unique identifier for the plugin\n   * @type {string}\n   */\n  name: \"router\",\n\n  /**\n   * Plugin version\n   * @type {string}\n   */\n  version: \"1.0.0-rc.11\",\n\n  /**\n   * Plugin description\n   * @type {string}\n   */\n  description: \"Client-side routing for Eleva applications\",\n\n  /**\n   * Installs the RouterPlugin into an Eleva instance.\n   *\n   * @param {Eleva} eleva - The Eleva instance\n   * @param {RouterOptions} options - Router configuration options\n   * @param {string} options.mount - A CSS selector for the main element where the app is mounted\n   * @param {RouteDefinition[]} options.routes - An array of route definitions\n   * @param {'hash' | 'query' | 'history'} [options.mode='hash'] - The routing mode\n   * @param {string} [options.queryParam='page'] - The query parameter to use in 'query' mode\n   * @param {string} [options.viewSelector='view'] - The selector for the view element within a layout\n   * @param {boolean} [options.autoStart=true] - Whether to start the router automatically\n   * @param {NavigationGuard} [options.onBeforeEach] - A global guard executed before every navigation\n   * @param {string | ComponentDefinition | (() => Promise<{default: ComponentDefinition}>)} [options.globalLayout] - A global layout for all routes\n   *\n   * @example\n   * // main.js\n   * import Eleva from 'eleva';\n   * import { RouterPlugin } from './plugins/RouterPlugin.js';\n   *\n   * const app = new Eleva('myApp');\n   *\n   * const HomePage = { template: () => `<h1>Home</h1>` };\n   * const AboutPage = { template: () => `<h1>About Us</h1>` };\n   *\n   * app.use(RouterPlugin, {\n   *  mount: '#app',\n   *  routes: [\n   *    { path: '/', component: HomePage },\n   *    { path: '/about', component: AboutPage }\n   *  ]\n   * });\n   */\n  install(eleva, options = {}) {\n    if (!options.mount) {\n      throw new Error(\"[RouterPlugin] 'mount' option is required\");\n    }\n\n    if (!options.routes || !Array.isArray(options.routes)) {\n      throw new Error(\"[RouterPlugin] 'routes' option must be an array\");\n    }\n\n    /**\n     * Registers a component definition with the Eleva instance.\n     * This method handles both inline component objects and pre-registered component names.\n     *\n     * @param {any} def - The component definition to register\n     * @param {string} type - The type of component for naming (e.g., \"Route\", \"Layout\")\n     * @returns {string | null} The registered component name or null if no definition provided\n     */\n    const register = (def, type) => {\n      if (!def) return null;\n\n      if (typeof def === \"object\" && def !== null && !def.name) {\n        const name = `Eleva${type}Component_${Math.random()\n          .toString(36)\n          .slice(2, 11)}`;\n\n        try {\n          eleva.component(name, def);\n          return name;\n        } catch (error) {\n          throw new Error(\n            `[RouterPlugin] Failed to register ${type} component: ${error.message}`\n          );\n        }\n      }\n      return def;\n    };\n\n    if (options.globalLayout) {\n      options.globalLayout = register(options.globalLayout, \"GlobalLayout\");\n    }\n\n    (options.routes || []).forEach((route) => {\n      route.component = register(route.component, \"Route\");\n      if (route.layout) {\n        route.layout = register(route.layout, \"RouteLayout\");\n      }\n    });\n\n    const router = new Router(eleva, options);\n    eleva.router = router;\n\n    if (options.autoStart !== false) {\n      queueMicrotask(() => router.start());\n    }\n\n    // Add plugin metadata to the Eleva instance\n    if (!eleva.plugins) {\n      eleva.plugins = new Map();\n    }\n    eleva.plugins.set(this.name, {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      options,\n    });\n\n    // Add utility methods for manual router access\n    eleva.navigate = router.navigate.bind(router);\n    eleva.getCurrentRoute = () => router.currentRoute.value;\n    eleva.getRouteParams = () => router.currentParams.value;\n    eleva.getRouteQuery = () => router.currentQuery.value;\n\n    return router;\n  },\n\n  /**\n   * Uninstalls the plugin from the Eleva instance\n   *\n   * @param {Eleva} eleva - The Eleva instance\n   */\n  async uninstall(eleva) {\n    if (eleva.router) {\n      await eleva.router.destroy();\n      delete eleva.router;\n    }\n\n    // Remove plugin metadata\n    if (eleva.plugins) {\n      eleva.plugins.delete(this.name);\n    }\n\n    // Remove utility methods\n    delete eleva.navigate;\n    delete eleva.getCurrentRoute;\n    delete eleva.getRouteParams;\n    delete eleva.getRouteQuery;\n  },\n};\n\n// Short name export for convenience\nexport { RouterPlugin as Router };\n"],"names":["CoreErrorHandler","handle","error","context","details","message","formattedError","Error","originalError","console","warn","log","Router","constructor","eleva","options","mode","queryParam","viewSelector","routes","_processRoutes","emitter","isStarted","_isNavigating","_navigationId","eventListeners","currentRoute","signal","previousRoute","currentParams","currentQuery","currentLayout","currentView","isReady","plugins","Map","_beforeEachGuards","onBeforeEach","push","errorHandler","_scrollPositions","_validateOptions","includes","processedRoutes","route","segments","_parsePathIntoSegments","path","normalizedPath","replace","split","filter","Boolean","map","segment","startsWith","paramName","substring","type","name","value","_findViewElement","container","selector","querySelector","start","window","document","mount","mountSelector","handler","_handleRouteChange","addEventListener","removeEventListener","emit","destroy","plugin","values","forEach","cleanup","unmount","stop","navigate","location","params","target","_buildPath","query","Object","keys","length","queryString","URLSearchParams","toString","_isSameRoute","navigationSuccessful","_proceedWithNavigation","currentNavId","state","historyMethod","newUrl","pathname","search","history","replaceState","hash","url","_buildQueryUrl","queueMicrotask","urlParams","set","current","targetPath","targetQuery","_parseQuery","JSON","stringify","result","key","entries","encodedValue","encodeURIComponent","String","RegExp","isPopState","from","toLocation","_getCurrentLocation","fullUrl","currentUrl","href","fullPath","toMatch","_matchRoute","notFoundRoute","find","pathMatch","decodeURIComponent","to","meta","matched","canNavigate","_runGuards","x","scrollX","pageXOffset","y","scrollY","pageYOffset","resolveContext","layoutComponent","pageComponent","cancelled","redirectTo","_resolveComponents","toLayout","layout","globalLayout","fromLayout","tryUnmount","instance","afterLeave","renderContext","_render","scrollContext","savedPosition","get","afterEnter","navContext","guards","beforeLeave","beforeEnter","guard","_resolveStringComponent","def","componentDef","_components","componentName","availableComponents","Array","_resolveFunctionComponent","funcStr","isAsyncImport","default","function","_validateComponentDefinition","definition","template","_resolveComponent","undefined","effectiveLayout","Promise","all","component","mountEl","layoutInstance","_wrapComponentWithChildren","viewEl","viewInstance","_createRouteGetter","property","defaultValue","_wrapComponent","originalSetup","setup","self","ctx","router","bind","previous","wrappedComponent","children","wrappedChildren","childComponent","slice","pathSegments","isMatch","i","routeSegment","pathSegment","addRoute","parentRoute","hasRoute","processedRoute","wildcardIndex","findIndex","r","splice","removeRoute","index","removedRoute","some","getRoutes","getRoute","indexOf","onAfterEnter","hook","on","onAfterLeave","onAfterEach","onError","use","install","has","existingPlugin","getPlugins","getPlugin","removePlugin","delete","setErrorHandler","RouterPlugin","version","description","isArray","register","Math","random","autoStart","getCurrentRoute","getRouteParams","getRouteQuery","uninstall"],"mappings":";;;;;;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA,MAAMA,gBAAgB,GAAG;EACvB;EACF;EACA;EACA;EACA;EACA;EACA;IACEC,MAAMA,CAACC,KAAK,EAAEC,OAAO,EAAEC,OAAO,GAAG,EAAE,EAAE;MACnC,MAAMC,OAAO,GAAG,CAAA,cAAA,EAAiBF,OAAO,KAAKD,KAAK,CAACG,OAAO,CAAA,CAAE;EAC5D,IAAA,MAAMC,cAAc,GAAG,IAAIC,KAAK,CAACF,OAAO,CAAC;;EAEzC;MACAC,cAAc,CAACE,aAAa,GAAGN,KAAK;MACpCI,cAAc,CAACH,OAAO,GAAGA,OAAO;MAChCG,cAAc,CAACF,OAAO,GAAGA,OAAO;EAEhCK,IAAAA,OAAO,CAACP,KAAK,CAACG,OAAO,EAAE;QAAEH,KAAK;QAAEC,OAAO;EAAEC,MAAAA;EAAQ,KAAC,CAAC;EACnD,IAAA,MAAME,cAAc;IACtB,CAAC;EAED;EACF;EACA;EACA;EACA;EACEI,EAAAA,IAAIA,CAACL,OAAO,EAAED,OAAO,GAAG,EAAE,EAAE;MAC1BK,OAAO,CAACC,IAAI,CAAC,CAAA,cAAA,EAAiBL,OAAO,CAAA,CAAE,EAAED,OAAO,CAAC;IACnD,CAAC;EAED;EACF;EACA;EACA;EACA;EACA;IACEO,GAAGA,CAACN,OAAO,EAAEH,KAAK,EAAEE,OAAO,GAAG,EAAE,EAAE;EAChCK,IAAAA,OAAO,CAACP,KAAK,CAAC,CAAA,cAAA,EAAiBG,OAAO,EAAE,EAAE;QAAEH,KAAK;EAAEE,MAAAA;EAAQ,KAAC,CAAC;EAC/D,EAAA;EACF,CAAC;;EAED;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA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"}